# 开始

### 什么是 `Flowable`

`Flowable` 是一个使用Java编写的轻量级业务流程引擎。`Flowable` 流程引擎可用于部署BPMN 2.0流程定义（用于定义流程的行业XML标准）， 创建这些流程定义的流程实例，进行查询，访问运行中或历史的流程实例与相关数据，等等。

所有使用 `Flowable` 的方法的共同点是核心引擎。核心引擎是一组服务的集合，并提供管理与执行业务流程的API。

### `Flowable` 与 `Activiti` 的关系

`Flowable` fork 于 `Activiti` ，而 `Activiti` 也是一个工作流引擎。

### 创建命令行应用

###### 创建流程引擎

例子（简单的请假流程）：

* 雇员(employee)申请几天的假期
* 经理(manager)批准或驳回申请
* 我们会模拟将申请注册到某个外部系统，并给雇员发送结果邮件

**1. maven依赖**

```xml
<dependencies>
    <dependency>
        <groupId>org.flowable</groupId>
        <artifactId>flowable-engine</artifactId>
        <version>${flowable-version}</version>
    </dependency>

    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <version>${h2-version}</version>
    </dependency>

    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-log4j12</artifactId>
        <version>${sl4j-version}</version>
    </dependency>
</dependencies>
```

上面的依赖中 `slf4j-log4j12` 表明使用 `log4j` 作为 `sl4j` 的实现，当然也可以使用其它实现，如 `logback` ； `h2` 表示使用 `h2` 这种内存数据库来存储执行与历史数据，当然这里也可以使用其它数据库。

**2. log4j.properties**

```properties
log4j.rootLogger=DEBUG, CA

log4j.appender.CA=org.apache.log4j.ConsoleAppender
log4j.appender.CA.layout=org.apache.log4j.PatternLayout
log4j.appender.CA.layout.ConversionPattern= %d{hh:mm:ss,SSS} [%t] %-5p %c %x - %m%n
```

**3. Java代码**

```java
package org.fade.demo.flowabledemo;

import org.flowable.engine.ProcessEngine;
import org.flowable.engine.ProcessEngineConfiguration;
import org.flowable.engine.impl.cfg.StandaloneProcessEngineConfiguration;

/**
 * @author fade
 * @date 2021/09/24
 */
public class HolidayRequest {

    public static void main(String[] args) {
        ProcessEngineConfiguration cfg = new StandaloneProcessEngineConfiguration()
                .setJdbcUrl("jdbc:h2:mem:flowable;DB_CLOSE_DELAY=-1")
                .setJdbcUsername("sa")
                .setJdbcPassword("")
                .setJdbcDriver("org.h2.Driver")
                .setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);

        ProcessEngine processEngine = cfg.buildProcessEngine();
    }

}
```

一个 `ProcessEngine` 由一个 `ProcessEngineConfiguration` 实例创建， `ProcessEngine` 是线程安全的，一个应用中只需实例化一次。上面的代码中使用了 `StandaloneProcessEngineConfiguration` ，这表明引擎是完全独立创建及使用的，在不同情况下有可能要使用不同的的 `ProcessEngineConfiguration` 来创建引擎，如 `Spring` 环境下使用 `SpringProcessEngineConfiguration` 。

###### 部署流程定义

`Flowable` 引擎需要将流程定义为BPMN 2.0格式，这是一个被业界广泛接受的XML标准。在 `Flowable` 术语中，我们将其称为一个流程定义(process definition)。一个流程定义可以启动多个流程实例(process instance)。流程定义可以看做是重复执行流程的蓝图。在这个例子中，流程定义定义了请假的各个步骤，而一个流程实例对应某个雇员提出的一个请假申请。

BPMN 2.0有可视化部分：使用标准方式定义了每个步骤类型（人工任务，自动服务调用，等等）如何呈现，以及如何互相连接。这样BPMN 2.0标准就使技术人员与业务人员能用双方都能理解的方式交流业务流程。

例子的流程定义如下图所示：

![getting.started.bpmn.process.png](../../img/BPMN/getting.started.bpmn.process.png)

上面的流程定义有几个要说明的地方：

* 左边的圆圈叫做启动事件（ `start event` ），是一个流程实例的起点。
* 第一个矩形是用户任务（ `user task` ），是流程中人类用户操作的步骤。
* 带叉的菱形是排他网关（ `exclusive gateway` ），会将流程实例路由至不同路径



